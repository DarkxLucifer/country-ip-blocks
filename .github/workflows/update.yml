      - name: Commit, push branch (safe + debug)
        env:
          REPO: ${{ github.repository }}
        run: |
          set -euxo pipefail

          # Ensure each country has a .cidr file (non-empty). This avoids "no file" surprises.
          mkdir -p generated
          COUNTRIES="US IN CN GB DE FR JP BR RU AU"
          for cc in $COUNTRIES; do
            CIDR_FILE="generated/${cc}.cidr"
            DEBUG_FILE="generated/${cc}.debug"
            STDERR_FILE="generated/${cc}.stderr"
            # if the cidr file does not exist or is empty, write a clear error header
            if [ ! -s "$CIDR_FILE" ]; then
              echo "# ERROR: no CIDR output generated for $cc" > "$CIDR_FILE"
              [ -f "$DEBUG_FILE" ] && echo "# See: $DEBUG_FILE" >> "$CIDR_FILE"
              [ -f "$STDERR_FILE" ] && echo "# See: $STDERR_FILE" >> "$CIDR_FILE"
            fi
          done

          # show what will be committed
          echo "=== generated files (pre-add) ==="
          ls -lah generated || true
          echo "=== sample contents (first 40 lines) ==="
          head -n 40 generated/US.cidr || true
          head -n 40 generated/US.debug || true
          head -n 40 generated/US.stderr || true

          # Git: create branch, add everything in generated, show status, and commit if changes exist
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          BRANCH="update/country-cidrs-$(date +%s)"
          git checkout -b "$BRANCH"

          # Add all changes in repo (safe)
          git add -A

          echo "=== git status (after add) ==="
          git status --porcelain --untracked-files=all || true

          # commit only when there are changes
          if git diff-index --quiet HEAD --; then
            echo "No changes to commit"
          else
            git commit -m "Automated update of country CIDR lists"
            git push --set-upstream origin "$BRANCH"
            echo "## Branch pushed: $BRANCH"
            echo "## Create a PR here:"
            echo "   https://github.com/${{ github.repository }}/pull/new/${BRANCH}"
          fi
